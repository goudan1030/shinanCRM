# 合同生成签署系统设计方案

## 🎯 系统概述

设计一个安全可靠、成本低的合同生成和电子签署系统，支持用户付费后自动生成合同、发送给客户签署、生成PDF下载等功能。

## 📋 功能需求分析

### 核心功能
1. **合同模板管理**：支持多种合同模板（会员服务合同、一次性服务合同等）
2. **合同生成**：根据用户信息和付费情况自动生成合同
3. **电子签署**：支持客户在线签署合同
4. **PDF生成**：将签署后的合同生成PDF文件
5. **合同管理**：合同状态跟踪、历史记录等
6. **安全验证**：确保合同真实性和不可篡改性

### 业务流程
```
用户付费 → 生成合同 → 发送签署链接 → 客户签署 → 生成PDF → 存储归档
```

## 🏗️ 技术架构设计

### 1. 合同模板系统

**方案选择**：基于HTML模板 + 变量替换
- **优势**：成本低、灵活性强、易于维护
- **实现**：使用Handlebars.js或类似模板引擎

**模板结构**：
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{contractTitle}}</title>
    <style>
        /* 合同样式 */
        .contract-header { text-align: center; margin-bottom: 30px; }
        .contract-content { line-height: 1.6; margin: 20px 0; }
        .signature-section { margin-top: 50px; }
        .signature-line { border-bottom: 1px solid #000; width: 200px; display: inline-block; }
    </style>
</head>
<body>
    <div class="contract-header">
        <h1>{{contractTitle}}</h1>
        <p>合同编号：{{contractNumber}}</p>
        <p>签署日期：{{signDate}}</p>
    </div>
    
    <div class="contract-content">
        <!-- 合同内容 -->
        <p>甲方：{{companyName}}</p>
        <p>乙方：{{customerName}}</p>
        <!-- 更多合同条款... -->
    </div>
    
    <div class="signature-section">
        <p>甲方签字：<span class="signature-line"></span></p>
        <p>乙方签字：<span class="signature-line"></span></p>
    </div>
</body>
</html>
```

### 2. 电子签名方案

**方案选择**：Canvas手写签名 + 数字证书验证
- **成本**：几乎为零（使用开源库）
- **安全性**：通过数字证书和哈希验证确保真实性

**实现步骤**：
1. 使用Canvas API让用户手写签名
2. 将签名转换为Base64图片
3. 生成签名哈希值
4. 使用时间戳和随机数确保唯一性

**签名验证**：
```javascript
// 生成签名哈希
function generateSignatureHash(signatureData, timestamp, nonce) {
    const data = signatureData + timestamp + nonce;
    return crypto.createHash('sha256').update(data).digest('hex');
}

// 验证签名
function verifySignature(signatureData, timestamp, nonce, hash) {
    const expectedHash = generateSignatureHash(signatureData, timestamp, nonce);
    return expectedHash === hash;
}
```

### 3. PDF生成方案

**方案选择**：Puppeteer + HTML转PDF
- **成本**：服务器资源（约$5-10/月）
- **优势**：高质量PDF、支持复杂布局、成本低

**实现**：
```javascript
const puppeteer = require('puppeteer');

async function generatePDF(htmlContent, options = {}) {
    const browser = await puppeteer.launch({
        headless: true,
        args: ['--no-sandbox', '--disable-setuid-sandbox']
    });
    
    const page = await browser.newPage();
    await page.setContent(htmlContent);
    
    const pdf = await page.pdf({
        format: 'A4',
        printBackground: true,
        margin: {
            top: '20mm',
            right: '20mm',
            bottom: '20mm',
            left: '20mm'
        },
        ...options
    });
    
    await browser.close();
    return pdf;
}
```

### 4. 数据库设计

**合同表 (contracts)**：
```sql
CREATE TABLE contracts (
    id BIGINT PRIMARY KEY,
    contract_number VARCHAR(50) UNIQUE NOT NULL,
    member_id BIGINT NOT NULL,
    contract_type ENUM('MEMBERSHIP', 'ONE_TIME', 'ANNUAL') NOT NULL,
    template_id BIGINT NOT NULL,
    status ENUM('DRAFT', 'PENDING', 'SIGNED', 'EXPIRED', 'CANCELLED') DEFAULT 'DRAFT',
    content TEXT NOT NULL,
    variables JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    signed_at TIMESTAMP NULL,
    expires_at TIMESTAMP NULL,
    pdf_url VARCHAR(500),
    signature_data JSON,
    signature_hash VARCHAR(64),
    FOREIGN KEY (member_id) REFERENCES members(id)
);
```

**合同模板表 (contract_templates)**：
```sql
CREATE TABLE contract_templates (
    id BIGINT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type ENUM('MEMBERSHIP', 'ONE_TIME', 'ANNUAL') NOT NULL,
    template_content TEXT NOT NULL,
    variables_schema JSON,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**合同签署记录表 (contract_signatures)**：
```sql
CREATE TABLE contract_signatures (
    id BIGINT PRIMARY KEY,
    contract_id BIGINT NOT NULL,
    signer_type ENUM('CUSTOMER', 'COMPANY') NOT NULL,
    signature_data TEXT NOT NULL,
    signature_hash VARCHAR(64) NOT NULL,
    signed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR(45),
    user_agent TEXT,
    FOREIGN KEY (contract_id) REFERENCES contracts(id)
);
```

### 5. API接口设计

**合同生成API**：
```typescript
// POST /api/contracts/generate
interface GenerateContractRequest {
    memberId: number;
    contractType: 'MEMBERSHIP' | 'ONE_TIME' | 'ANNUAL';
    templateId?: number;
    variables?: Record<string, any>;
}

interface GenerateContractResponse {
    contractId: number;
    contractNumber: string;
    signUrl: string;
    expiresAt: string;
}
```

**合同签署API**：
```typescript
// POST /api/contracts/{contractId}/sign
interface SignContractRequest {
    signatureData: string; // Base64签名图片
    signerType: 'CUSTOMER' | 'COMPANY';
}

interface SignContractResponse {
    success: boolean;
    pdfUrl?: string;
    message: string;
}
```

**PDF下载API**：
```typescript
// GET /api/contracts/{contractId}/pdf
// 返回PDF文件流
```

### 6. 前端界面设计

**合同签署页面**：
```tsx
interface ContractSignPageProps {
    contractId: string;
    contractData: ContractData;
}

export default function ContractSignPage({ contractId, contractData }: ContractSignPageProps) {
    const [signature, setSignature] = useState<string>('');
    const [isSigning, setIsSigning] = useState(false);
    
    const handleSign = async () => {
        if (!signature) return;
        
        setIsSigning(true);
        try {
            const response = await fetch(`/api/contracts/${contractId}/sign`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    signatureData: signature,
                    signerType: 'CUSTOMER'
                })
            });
            
            const result = await response.json();
            if (result.success) {
                // 显示成功消息，提供PDF下载链接
                toast.success('合同签署成功！');
            }
        } catch (error) {
            toast.error('签署失败，请重试');
        } finally {
            setIsSigning(false);
        }
    };
    
    return (
        <div className="contract-sign-page">
            <div className="contract-content">
                <div dangerouslySetInnerHTML={{ __html: contractData.content }} />
            </div>
            
            <div className="signature-section">
                <h3>请在此处签名</h3>
                <SignaturePad
                    onSignatureChange={setSignature}
                    width={400}
                    height={200}
                />
                <button 
                    onClick={handleSign}
                    disabled={!signature || isSigning}
                    className="sign-button"
                >
                    {isSigning ? '签署中...' : '确认签署'}
                </button>
            </div>
        </div>
    );
}
```

### 7. 安全方案

**数据安全**：
1. **HTTPS传输**：所有API请求使用HTTPS
2. **签名验证**：使用SHA-256哈希验证签名完整性
3. **时间戳验证**：防止重放攻击
4. **IP记录**：记录签署时的IP地址

**合同安全**：
1. **数字水印**：在PDF中添加不可见水印
2. **哈希验证**：合同内容生成哈希值，防止篡改
3. **时间戳**：记录签署时间，确保时效性
4. **备份存储**：合同PDF备份到云存储

**访问控制**：
1. **签署链接**：使用一次性签署链接，包含过期时间
2. **权限验证**：验证用户身份和合同归属
3. **操作日志**：记录所有操作日志

## 💰 成本分析

### 开发成本
- **开发时间**：2-3周
- **人力成本**：1个全栈开发者

### 运营成本
- **服务器**：$10-20/月（PDF生成服务）
- **存储**：$5-10/月（合同PDF存储）
- **域名SSL**：$0（使用现有域名）
- **总计**：$15-30/月

### 第三方服务成本
- **无**：完全自建，无第三方服务依赖

## 🚀 实施计划

### 第一阶段（1周）：基础功能
1. 数据库设计和创建
2. 合同模板系统
3. 基础API接口

### 第二阶段（1周）：签署功能
1. 电子签名组件
2. 签署API
3. 前端签署页面

### 第三阶段（1周）：PDF生成
1. PDF生成服务
2. 文件存储
3. 下载功能

### 第四阶段（0.5周）：安全优化
1. 安全验证
2. 日志记录
3. 测试和优化

## 🔧 技术栈

**后端**：
- Next.js 14 API Routes
- Puppeteer (PDF生成)
- MySQL (数据存储)
- Node.js crypto (签名验证)

**前端**：
- React 18
- Signature Pad (手写签名)
- Tailwind CSS (样式)

**部署**：
- Vercel/Netlify (前端)
- 阿里云ECS (后端服务)
- 阿里云OSS (文件存储)

## 📊 预期效果

1. **自动化程度**：90%以上合同自动生成
2. **签署效率**：从3-5天缩短到几分钟
3. **成本节约**：相比传统纸质合同节约80%成本
4. **安全性**：达到电子签名法要求
5. **用户体验**：简单易用的签署流程

---

**方案优势**：
- ✅ 成本极低（月成本<$30）
- ✅ 安全可靠（多重验证）
- ✅ 易于维护（纯自建）
- ✅ 扩展性强（模块化设计）
- ✅ 符合法规（电子签名法）
