#!/bin/bash

# CVE-2025-66478 Next.js React Server Components 远程代码执行漏洞修复脚本
# 漏洞说明：未经验证的攻击者可以在受影响的服务器上执行任意代码
# 修复方案：升级 Next.js 到 15.2.6 或更高版本（必须）

set -e

echo "=========================================="
echo "CVE-2025-66478 漏洞修复脚本"
echo "Next.js React Server Components RCE 漏洞"
echo "=========================================="
echo ""

# 颜色输出
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 检查是否在项目根目录
if [ ! -f "package.json" ]; then
    echo -e "${RED}错误：请在项目根目录运行此脚本${NC}"
    exit 1
fi

echo -e "${RED}⚠️  警告：这是一个严重的远程代码执行漏洞！${NC}"
echo -e "${RED}必须立即升级 Next.js 到安全版本！${NC}"
echo ""

echo -e "${YELLOW}步骤 1: 检查当前 Next.js 版本${NC}"

# 检查当前 Next.js 版本
CURRENT_VERSION=$(grep -o '"next": "[^"]*"' package.json | cut -d'"' -f4 | sed 's/[^0-9.]//g')
echo "当前 Next.js 版本: $CURRENT_VERSION"

# 确定需要升级到的版本
if [[ "$CURRENT_VERSION" == 15.0.* ]]; then
    TARGET_VERSION="15.0.5"
elif [[ "$CURRENT_VERSION" == 15.1.* ]]; then
    TARGET_VERSION="15.1.9"
elif [[ "$CURRENT_VERSION" == 15.2.* ]]; then
    TARGET_VERSION="15.2.6"
elif [[ "$CURRENT_VERSION" == 15.3.* ]]; then
    TARGET_VERSION="15.3.6"
elif [[ "$CURRENT_VERSION" == 15.4.* ]]; then
    TARGET_VERSION="15.4.8"
elif [[ "$CURRENT_VERSION" == 15.5.* ]]; then
    TARGET_VERSION="15.5.7"
elif [[ "$CURRENT_VERSION" == 16.0.* ]]; then
    TARGET_VERSION="16.0.7"
else
    # 默认升级到最新稳定版本
    TARGET_VERSION="15.2.6"
    echo -e "${YELLOW}⚠️  无法自动确定目标版本，将升级到 15.2.6${NC}"
fi

echo "目标 Next.js 版本: $TARGET_VERSION"
echo ""

echo -e "${YELLOW}步骤 2: 升级 Next.js 和相关依赖${NC}"
echo "正在更新 package.json..."

# 安装更新的依赖
echo "正在安装更新的依赖包..."
npm install next@$TARGET_VERSION eslint-config-next@$TARGET_VERSION --save --save-exact

echo -e "${GREEN}✓ Next.js 已升级到 $TARGET_VERSION${NC}"
echo ""

echo -e "${YELLOW}步骤 3: 重新构建应用${NC}"
echo "正在清理构建缓存..."
rm -rf .next

echo "正在构建应用..."
npm run build

echo -e "${GREEN}✓ 应用构建完成${NC}"
echo ""

echo -e "${YELLOW}步骤 4: 验证修复${NC}"

# 验证版本
INSTALLED_VERSION=$(npm list next 2>/dev/null | grep next@ | head -1 | awk '{print $2}' | sed 's/@//')
echo "已安装的 Next.js 版本: $INSTALLED_VERSION"

if [[ "$INSTALLED_VERSION" == "$TARGET_VERSION"* ]]; then
    echo -e "${GREEN}✓ 版本验证通过${NC}"
else
    echo -e "${RED}✗ 版本验证失败，请手动检查${NC}"
fi

echo ""
echo -e "${YELLOW}步骤 5: 部署说明${NC}"
echo ""
echo "请按照以下步骤完成部署："
echo ""
echo "1. 如果修改了代码，请提交更改："
echo "   git add package.json package-lock.json"
echo "   git commit -m 'fix(security): 修复 CVE-2025-66478 RCE 漏洞'"
echo "   git push"
echo ""
echo "2. 在服务器上拉取最新代码："
echo "   cd /www/wwwroot/admin.xinghun.info"
echo "   git pull"
echo "   npm install"
echo ""
echo "3. 重新构建应用："
echo "   rm -rf .next"
echo "   npm run build"
echo ""
echo "4. 重启应用（根据您的部署方式选择）："
echo "   # 使用 PM2："
echo "   pm2 restart sncrm"
echo "   # 或"
echo "   pm2 restart admin.xinghun.info"
echo ""
echo "5. 验证修复："
echo "   - 检查 Next.js 版本：npm list next"
echo "   - 检查应用是否正常运行"
echo "   - 测试所有功能，特别是 React Server Components"
echo "   - 检查应用日志：pm2 logs sncrm"
echo ""
echo -e "${GREEN}=========================================="
echo "修复完成！"
echo "==========================================${NC}"
echo ""
echo -e "${RED}重要提醒：${NC}"
echo "1. 这是一个严重的远程代码执行漏洞，必须立即修复"
echo "2. 升级到安全版本是唯一有效的修复方案"
echo "3. 建议在测试环境充分测试后再部署到生产环境"
echo "4. 建议创建服务器快照作为备份"
echo "5. 部署后立即验证应用功能是否正常"
echo ""
echo "相关文档："
echo "- docs/CVE-2025-66478-修复说明.md"
echo "- https://nextjs.org/blog/CVE-2025-66478"
echo ""
