# 推送功能说明

## 功能概述

在APP管理模块中新增了iOS推送通知功能，用于向用户发送重要消息和系统通知。支持真正的推送通知，即使用户没有打开APP也能收到消息。

## 功能模块

### 1. 公告推送 (`/app/announcement`)
- **功能**: 向用户发送重要公告信息
- **特点**: 
  - 支持全体推送或定向推送
  - 可指定目标用户ID列表
  - 实时发送，无需等待
- **权限**: 需要管理员权限（role >= 3）

### 2. 系统通知推送 (`/app/notification`)
- **功能**: 向所有用户发送系统通知
- **特点**:
  - 面向全体用户
  - 用于系统维护、更新等重要通知
- **权限**: 需要管理员权限（role >= 3）

### 3. 推送日志 (`/app/push-logs`)
- **功能**: 查看推送历史记录
- **特点**:
  - 支持按类型、时间范围筛选
  - 分页显示
  - 显示推送详情和发送人信息
- **权限**: 需要管理员权限（role >= 3）

### 4. 推送配置 (`/app/push-config`)
- **功能**: 检查iOS推送通知配置状态
- **特点**:
  - 检查APNs配置项是否完整
  - 显示配置状态和说明
  - 帮助诊断推送问题
- **权限**: 需要管理员权限（role >= 3）

## API接口

### 1. 公告推送
```
POST /api/messages/push/announcement
Content-Type: application/json
Authorization: Bearer {admin_token}

{
  "title": "公告标题",
  "content": "公告内容",
  "target_users": [1, 2, 3]  // 可选：指定目标用户ID数组
}
```

### 2. 系统通知推送
```
POST /api/messages/push/system-notice
Content-Type: application/json
Authorization: Bearer {admin_token}

{
  "title": "系统通知标题",
  "content": "系统通知内容"
}
```

### 3. 设备令牌注册
```
POST /api/messages/push/register
Content-Type: application/json
Authorization: Bearer {user_token}

{
  "device_token": "iOS设备令牌",
  "platform": "ios",
  "app_version": "1.0.0"
}
```

### 4. 推送日志查询
```
GET /api/messages/push/logs?page=1&limit=20&type=announcement&start_date=2025-01-01&end_date=2025-01-31
Authorization: Bearer {admin_token}
```

## 数据库表结构

### push_logs (推送日志表)
```sql
CREATE TABLE push_logs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  type ENUM('announcement', 'system_notice') NOT NULL,
  title VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  target_users JSON NULL,
  created_by INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_type (type),
  INDEX idx_created_by (created_by),
  INDEX idx_created_at (created_at)
);
```

### device_tokens (设备令牌表)
```sql
CREATE TABLE device_tokens (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  device_token VARCHAR(255) NOT NULL,
  platform ENUM('ios', 'android') NOT NULL,
  app_version VARCHAR(20) NULL,
  is_active TINYINT(1) DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_device (user_id, device_token),
  INDEX idx_user_id (user_id),
  INDEX idx_platform (platform),
  INDEX idx_is_active (is_active)
);
```

## 使用方法

### 1. 发送公告
1. 进入APP管理 → 公告推送
2. 填写公告标题和内容
3. 选择是否启用定向推送
4. 如果启用定向推送，输入目标用户ID（逗号分隔）
5. 点击"发送公告"

### 2. 发送系统通知
1. 进入APP管理 → 通知推送
2. 填写通知标题和内容
3. 点击"发送通知"

### 3. 查看推送日志
1. 进入APP管理 → 推送日志
2. 可选择推送类型和时间范围进行筛选
3. 查看推送历史记录

## 注意事项

1. **权限要求**: 所有推送功能都需要管理员权限
2. **数据安全**: 推送内容会记录在数据库中，请谨慎发送敏感信息
3. **性能考虑**: 大量用户推送时可能需要较长时间
4. **错误处理**: 如果推送失败，会在日志中记录错误信息

## 技术实现

### iOS推送通知集成
系统已集成Apple Push Notification Service (APNs)：

1. **设备令牌管理**: 自动注册和管理iOS设备令牌
2. **推送服务**: 使用APNs发送真正的推送通知
3. **配置管理**: 支持开发和生产环境配置
4. **错误处理**: 完善的错误处理和日志记录

### 推送流程
1. iOS客户端注册设备令牌
2. 管理员发送推送消息
3. 系统查询目标用户的设备令牌
4. 通过APNs发送推送通知
5. 用户手机收到通知
6. 记录推送日志

### 推送模板
可以添加推送模板功能，预设常用的推送内容格式。

### 定时推送
可以添加定时推送功能，在指定时间自动发送推送。

### 推送统计
可以添加推送统计功能，显示推送成功率、用户点击率等数据。

## 故障排除

### 常见问题

1. **推送失败**
   - 检查管理员权限
   - 检查数据库连接
   - 查看服务器日志

2. **日志查询失败**
   - 检查数据库表是否存在
   - 检查查询参数格式

3. **页面加载缓慢**
   - 检查数据库索引
   - 优化查询语句

### 调试方法

1. 查看浏览器控制台错误信息
2. 查看服务器日志
3. 使用测试脚本验证API功能

## 配置要求

### APNs配置
需要在环境变量中配置以下参数：

```bash
APNS_KEY_ID=your-apns-key-id
APNS_TEAM_ID=your-apns-team-id
APNS_BUNDLE_ID=your-app-bundle-id
APNS_PRIVATE_KEY=your-apns-private-key
APNS_ENVIRONMENT=development
```

### 获取APNs配置
1. 登录Apple Developer账户
2. 创建APNs密钥
3. 下载私钥文件（.p8格式）
4. 获取Key ID和Team ID
5. 配置到环境变量中

## 更新日志

- **2025-01-27**: 新增iOS推送通知功能
- **2025-01-27**: 集成Apple Push Notification Service (APNs)
- **2025-01-27**: 新增推送配置检查功能
- **2025-01-27**: 新增推送日志查看功能
- **2025-01-27**: 新增设备令牌注册API
