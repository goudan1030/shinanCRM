# 企业微信会员查询功能说明

## 功能概述

用户可以通过企业微信应用发送会员编号，系统会自动查询并回复会员的详细信息。

## 功能特点

### 📱 使用方式
- 在企业微信应用中直接发送会员编号
- 系统自动识别编号格式并查询
- 返回详细的会员信息

### 🔍 支持的编号格式
- **M开头**：M17071、M12345
- **纯数字**：10921、12345（4-6位）
- **字母+数字**：A1234、B5678

### 📋 返回信息内容
- **基本信息**：编号、类型、状态、性别、年龄、身高体重
- **教育职业**：学历、职业
- **地区信息**：所在地、户口所在地、目标区域
- **基本条件**：房车情况、婚史、性取向
- **婚恋意向**：孩子需求、领证需求
- **个人描述**：自我介绍、择偶要求
- **时间信息**：注册时间、更新时间

## 技术实现

### 核心接口
- **`/api/wecom/message`** - 企业微信消息接收和处理
- **`/api/wecom/callback`** - 企业微信回调验证
- **`/api/wecom/verify`** - URL验证专用接口

### 测试接口
- **`/api/wecom/test-query`** - 测试会员查询功能
- **`/api/wecom/test-connection`** - 测试企业微信连通性
- **`/api/wecom/test-notification`** - 测试消息发送功能

### 关键功能
1. **消息解析**：支持XML格式的企业微信消息解析
2. **编号识别**：智能识别多种会员编号格式
3. **数据库查询**：支持多种查询方式（编号、ID等）
4. **信息格式化**：将会员信息格式化为易读的文本
5. **错误处理**：完整的错误处理和用户提示

## 使用示例

### 正确的查询方式
```
发送：M17071
返回：完整的会员详细信息

发送：10921  
返回：完整的会员详细信息

发送：查询 A1234
返回：完整的会员详细信息
```

### 未找到会员时
```
发送：M99999
返回：❌ 未找到会员编号为 "M99999" 的会员信息。请检查编号是否正确...
```

### 格式错误时
```
发送：你好
返回：💡 会员查询使用说明（帮助信息）
```

## 配置要求

### 企业微信应用配置
1. **接收消息URL**：`https://your-domain.com/api/wecom/message`
2. **Token**：`L411dhQg`
3. **AgentId**：`1000011`
4. **应用权限**：
   - 发送应用消息
   - 接收消息与事件

### 服务器配置
1. **IP白名单**：需要添加服务器IP到企业微信白名单
2. **数据库**：需要正确配置数据库连接
3. **企业微信配置**：需要在 `wecom_config` 表中配置正确的企业ID和密钥

## 测试方法

### 1. 测试编号识别
```bash
curl -X POST http://your-domain.com/api/wecom/test-query \
  -H "Content-Type: application/json" \
  -d '{"message": "M17071"}'
```

### 2. 测试连通性
```bash
curl -X GET http://your-domain.com/api/wecom/test-connection
```

### 3. 测试通知功能
```bash
curl -X POST http://your-domain.com/api/wecom/test-notification
```

## 状态检查

### 功能状态
- ✅ 消息接收接口已完成
- ✅ 编号识别算法已完成
- ✅ 数据库查询逻辑已完成
- ✅ 信息格式化已完成
- ✅ 错误处理已完成
- ✅ 帮助系统已完成

### 待解决问题
- ⚠️ 企业微信URL验证问题（需要配置IP白名单）
- ⚠️ 企业ID配置（需要提供正确的企业ID）

## 注意事项

1. **企业微信配置**：确保企业微信应用的接收消息URL配置正确
2. **数据库权限**：确保应用有权限查询 `members` 表
3. **网络连接**：确保服务器能正常访问企业微信API
4. **IP白名单**：必须将服务器IP添加到企业微信应用的白名单中

## 更新记录

- **2025-01-25**：完成所有核心功能开发
- **2025-01-25**：添加测试接口和文档
- **2025-01-25**：创建功能说明文档 