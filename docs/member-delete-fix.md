# 会员删除功能修复文档

## 问题描述

删除已经撤销的会员时，虽然API返回成功消息，但刷新后会员数据依然存在。

## 问题原因

1. 系统使用了`delete_member`存储过程进行会员删除，但该存储过程实现有问题或不存在
2. 数据库连接配置可能不正确，导致无法正确修改表结构或执行存储过程
3. 会员查询API和删除API之间缺乏一致性

## 修复方案

我们提供了两种修复方案：

### 方案一：软删除方案（推荐）

通过添加软删除字段(`is_deleted`和`deleted_at`)到`members`表，实现逻辑删除而非物理删除：

1. 表结构修改 - 添加软删除字段
2. 创建/修复`delete_member`存储过程
3. 修改会员查询API，默认只显示未删除的会员
4. 修改会员删除API，通过存储过程实现软删除

此方案需要数据库管理员权限才能修改表结构和创建存储过程。

### 方案二：硬删除方案（临时方案）

如果无法获得数据库管理员权限，我们提供了一个简单的硬删除方案：

1. 修改会员删除API，直接执行DELETE语句删除会员记录
2. 尝试记录删除操作到日志表（如果存在）
3. 清除缓存，确保前端立即反映删除操作

此方案简单易行，但会永久删除数据，无法恢复。

## 配置和执行修复

我们提供了一个便捷的配置脚本来帮助您设置环境变量和执行修复：

```bash
npm run db:setup
```

此脚本将：
1. 引导您设置数据库连接信息
2. 保存配置到.env文件
3. 执行数据库修复脚本
4. 提供其他诊断工具的信息

您也可以单独执行以下命令：

```bash
# 检查数据库连接
npm run db:check-connection

# 诊断数据库问题
npm run db:diagnose

# 修复数据库用户权限
npm run db:fix-permissions
```

## 测试验证

修复完成后，请进行以下测试：

1. 在会员列表页面找到一个已撤销的会员
2. 点击删除按钮
3. 确认删除操作
4. 刷新页面，验证会员已经从列表中消失

## 后续优化建议

1. 实现完整的软删除方案，保留数据以备恢复
2. 添加恢复已删除会员的功能
3. 添加按删除状态筛选会员的功能
4. 完善会员操作日志记录
5. 定期对数据库进行维护和优化 