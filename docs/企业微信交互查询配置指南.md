# 企业微信交互查询功能配置指南

## 📋 功能介绍

这个功能允许用户在企业微信中发送会员编号，系统自动回复该会员的详细信息，大大提高工作效率。

### 🎯 功能特点
- 🔍 **智能识别**：自动识别多种会员编号格式
- 📊 **完整信息**：返回会员的所有详细资料
- 🚀 **即时响应**：实时查询并回复
- 💬 **友好提示**：智能错误处理和使用指导

## 🛠️ 配置步骤

### 第一步：环境变量配置

在项目根目录的 `.env` 文件中添加：

```env
# 企业微信Token（用于消息签名验证）
WECOM_TOKEN=WeCom_2024_Secure_Token_9527
```

**Token生成建议**：
- 使用随机字符串，长度16-32位
- 包含字母、数字和特殊字符
- 示例：`WeCom_2024_Secure_Token_9527`

### 第二步：企业微信后台配置

#### 1. 登录企业微信管理后台
访问：https://work.weixin.qq.com/wework_admin/frame

#### 2. 进入应用管理
- 点击左侧菜单"应用管理"
- 找到您的CRM应用并点击进入

#### 3. 配置接收消息
在应用详情页面，找到"接收消息"或"消息推送"设置：

- **URL配置**：`https://admin.xinghun.info/api/wecom/message`
- **Token**：填入您在环境变量中设置的 `WECOM_TOKEN`
- **EncodingAESKey**：点击"随机生成"（可选，本系统暂不使用加密）

#### 4. 验证URL
点击"保存"后，企业微信会向您的URL发送验证请求。如果配置正确，验证会自动通过。

#### 5. 启用消息推送
验证通过后，确保"消息推送"状态为"已启用"。

### 第三步：权限配置

#### 1. 应用可见范围
确保需要使用查询功能的员工在应用的可见范围内。

#### 2. API权限
确认应用具有以下权限：
- 发送消息到企业
- 接收用户消息

## 🧪 功能测试

### 测试消息解析功能

使用测试API验证会员编号识别：

```javascript
// 在浏览器Console中测试
fetch('/api/wecom/message-test', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ message: 'M17071' })
})
.then(r => r.json())
.then(d => console.log('测试结果:', d));
```

### 测试支持的编号格式

系统支持以下会员编号格式：

| 格式 | 示例 | 说明 |
|------|------|------|
| M+数字 | M17071, M12345 | 常见格式 |
| 纯数字 | 10921, 12345 | 4-6位数字 |
| 字母+数字 | A1234, B5678 | 字母开头 |
| 数字+字母+数字 | 1A123, 2B456 | 混合格式 |

### 测试查询功能

在企业微信中向应用发送以下消息：

1. **查询存在的会员**：
   - 发送：`M17071`
   - 预期：返回详细会员信息

2. **查询不存在的会员**：
   - 发送：`M99999`
   - 预期：提示未找到会员

3. **发送其他内容**：
   - 发送：`帮助`
   - 预期：显示使用说明

## 📱 使用说明

### 支持的查询方式

用户可以通过以下方式查询会员信息：

1. **直接发送编号**：
   ```
   M17071
   10921
   A1234
   ```

2. **带查询关键词**：
   ```
   查询 M17071
   会员 10921
   编号A1234
   ```

3. **获取帮助**：
   ```
   帮助
   help
   使用说明
   ```

### 返回信息格式

系统会返回完整的会员信息，包括：

- 🆔 基本信息（编号、类型、状态、性别、年龄、身高体重）
- 🎓 教育职业（学历、职业）
- 📍 地区信息（所在地、户口、目标区域）
- 💼 基本条件（房车、婚史、性取向）
- 👨‍👩‍👧‍👦 婚恋意向（孩子需求、领证需求）
- 💭 个人说明
- 💕 择偶要求
- 📅 时间信息（注册时间、更新时间）

## 🔧 故障排除

### 常见问题

#### 1. URL验证失败
**原因**：Token配置不匹配
**解决**：
- 检查环境变量中的 `WECOM_TOKEN` 是否正确
- 确保企业微信后台填入的Token完全一致

#### 2. 收不到消息
**原因**：
- 应用可见范围设置问题
- 消息推送未启用
**解决**：
- 检查应用可见范围，确保用户在范围内
- 确认消息推送状态为"已启用"

#### 3. 查询不到会员
**原因**：
- 会员编号格式不正确
- 会员数据已删除或不存在
**解决**：
- 使用测试API验证编号识别
- 检查数据库中的会员数据

#### 4. IP白名单问题
**原因**：服务器IP不在企业微信白名单中
**解决**：
- 使用IP信息API获取服务器IP：`/api/wecom/ip-info`
- 在企业微信后台添加IP到白名单

### 调试日志

查看服务器日志了解详细信息：
- 消息接收日志
- 编号识别结果
- 数据库查询结果
- 回复发送状态

## 🚀 进阶功能

### 扩展查询类型

您可以修改 `extractMemberNumber` 函数来支持更多编号格式。

### 自定义回复格式

修改 `formatMemberDetailsForReply` 函数来调整回复消息的格式。

### 添加权限控制

可以根据用户身份限制查询权限，只允许特定用户查询敏感信息。

## 📞 技术支持

如有问题，请联系技术支持团队或查看系统日志获取详细错误信息。

---

配置完成后，您的团队就可以在企业微信中快速查询会员信息了！🎉 