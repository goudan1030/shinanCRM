# 企业微信URL验证问题解决方案

## 🔍 问题描述

在企业微信后台配置API接收消息时，出现错误：
```
openapi回调地址请求不通过
```

## ✅ 验证结果

经过测试，您的URL验证接口完全正常：

### 本地环境测试
- ✅ URL验证成功
- ✅ 签名算法正确
- ✅ 响应格式正确

### 生产环境测试
- ✅ URL验证成功
- ✅ 签名算法正确
- ✅ 响应格式正确

## 🛠️ 解决方案

### 1. 清除企业微信后台缓存

**步骤：**
1. 在企业微信后台，先点击"取消"按钮
2. 重新进入"接收消息"配置页面
3. 重新填写配置信息
4. 点击"保存"按钮

### 2. 检查IP白名单配置

**问题原因：** 企业微信要求服务器IP必须在白名单中

**解决步骤：**
1. 登录企业微信管理后台
2. 进入"应用管理" → "应用" → 您的应用
3. 找到"IP白名单"配置
4. 添加您的服务器IP：`47.243.124.xxx`（请确认具体IP）
5. 保存配置

**获取服务器IP的方法：**
```bash
# 在服务器上运行
curl ifconfig.me
# 或者
curl ipinfo.io/ip
```

### 3. 检查域名备案

**问题原因：** 企业微信要求域名必须已备案且备案主体与企业主体相关

**检查步骤：**
1. 确认域名 `admin.xinghun.info` 已备案
2. 确认备案主体与企业微信企业主体相关
3. 如果备案主体不匹配，需要：
   - 重新备案域名
   - 或者使用已备案的相关域名

### 4. 重新生成Token和EncodingAESKey

**步骤：**
1. 在企业微信后台点击"随机获取"按钮重新生成Token
2. 点击"随机获取"按钮重新生成EncodingAESKey
3. 更新数据库中的配置：

```sql
UPDATE wecom_config SET 
  token = '新生成的Token',
  encoding_aes_key = '新生成的EncodingAESKey'
WHERE id = 1;
```

### 5. 检查应用权限

**确保应用有以下权限：**
- ✅ 通讯录 - 读取企业通讯录
- ✅ 应用 - 发送应用消息
- ✅ 客户联系 - 读取客户信息（可选）

### 6. 消息类型配置

**确保勾选以下消息类型：**
- ✅ 用户发送的普通消息（必需）
- ✅ 自定义菜单操作（可选）
- ✅ 审批状态通知事件（可选）

## 🔧 技术验证

### 当前配置状态
- **URL**: `https://admin.xinghun.info/api/wecom/message` ✅
- **Token**: `AYJtHyibFqZzUJ6Gdn6jr` ✅
- **EncodingAESKey**: `W4Vd1DVgpG1r15PVTPHP94zEkjh8bnsWOnFBz4O8N2k` ✅
- **签名算法**: 正确实现 ✅
- **响应格式**: 符合要求 ✅

### 测试命令
```bash
# 测试URL验证
node scripts/test-wecom-verify.js

# 测试生产环境
TEST_BASE_URL=https://admin.xinghun.info node scripts/test-wecom-verify.js

# 检查配置状态
node scripts/check-wecom-config.js
```

## 📋 检查清单

在重新配置前，请确认：

- [ ] 服务器IP已添加到企业微信白名单
- [ ] 域名已备案且备案主体正确
- [ ] 应用权限配置正确
- [ ] 消息类型配置正确
- [ ] Token和EncodingAESKey已重新生成
- [ ] 企业微信后台缓存已清除

## 🚨 常见错误及解决方法

### 错误1: "openapi回调地址请求不通过"
**原因：** 通常是IP白名单或域名备案问题
**解决：** 检查IP白名单和域名备案

### 错误2: "签名验证失败"
**原因：** Token不匹配或签名算法错误
**解决：** 重新生成Token并更新数据库

### 错误3: "URL不可达"
**原因：** 服务器未运行或网络问题
**解决：** 检查服务器状态和网络连接

## 📞 技术支持

如果按照以上步骤仍然无法解决问题，请：

1. 检查企业微信后台的错误日志
2. 查看服务器日志：`/www/wwwlogs/sncrm.error.log`
3. 运行诊断脚本：`node scripts/check-wecom-config.js`
4. 联系技术支持

## 🎯 预期结果

配置成功后，您应该能够：
1. 在企业微信后台成功保存配置
2. 在企业微信应用中发送消息
3. 收到自动回复的会员信息

---

**最后更新：** 2025-08-04
**状态：** URL验证接口正常，等待企业微信后台配置 