# SNCRM项目架构文档

## 项目概述

SNCRM是一个基于Next.js 14构建的客户关系管理系统，采用App Router架构。系统主要用于管理客户关系、收支管理、小程序管理和企业微信管理等功能。本文档详细描述了项目的架构设计、核心模块及其交互关系。

## 技术栈

- **前端框架**: Next.js 14 (App Router)
- **UI组件**: Shadcn UI
- **样式方案**: Tailwind CSS
- **状态管理**: React Context
- **表单处理**: React Hook Form + Zod
- **数据库**: MySQL (通过连接池管理)
- **认证**: 自定义JWT认证

## 项目架构图

```
┌──────────────────────────────────────────────────────────────┐
│                     客户端浏览器                              │
└───────────────────────────────┬──────────────────────────────┘
                                │
┌───────────────────────────────▼──────────────────────────────┐
│                    Next.js SSR/CSR 渲染                      │
└───────────────────────────────┬──────────────────────────────┘
                                │
┌───────────────────────────────▼──────────────────────────────┐
│                          中间件                              │
│      (权限验证、Token刷新、请求拦截 - src/middleware.ts)      │
└──┬──────────────────────────┬─────────────────────────┬─────┘
   │                          │                         │
┌──▼──────────────────┐ ┌─────▼───────────────┐ ┌──────▼──────────┐
│     页面路由        │ │     API 路由        │ │   静态资源      │
│  src/app/*/**       │ │ src/app/api/**      │ │                │
└──┬──────────────────┘ └─────┬───────────────┘ └─────────────────┘
   │                          │
┌──▼──────────────────┐ ┌─────▼───────────────┐
│    UI 组件层        │ │   服务层            │
│  src/components/**  │ │ src/lib/services/** │
└──┬──────────────────┘ └─────┬───────────────┘
   │                          │
┌──▼──────────────────┐ ┌─────▼───────────────┐
│    公共 Hook        │ │   工具库            │
│    src/hooks/**     │ │ src/lib/**          │
└──┬──────────────────┘ └─────┬───────────────┘
   │                          │
┌──▼──────────────────┐ ┌─────▼───────────────┐
│   Context 状态管理  │ │   数据库连接        │
│   src/contexts/**   │ │ src/lib/database.ts │
└────────────────────┘ └─────────────────────┘
```

## 核心模块及职责

### 1. 认证模块

**目录结构:**
- `src/lib/token.ts` - JWT Token处理(Node.js环境)
- `src/lib/token-edge.ts` - JWT Token处理(Edge环境)
- `src/lib/auth.ts` - 用户会话和权限管理
- `src/middleware.ts` - 认证中间件
- `src/app/api/auth/**` - 认证相关API
- `src/types/auth.ts` - 认证相关类型定义

**职责:**
- 用户登录验证和会话管理
- JWT Token的生成、验证和刷新
- 基于角色的权限控制
- 页面和API的访问限制

**关键交互:**
1. 中间件解析请求中的Token，验证其有效性和权限
2. 服务器组件通过`getSession()`和`hasRole()`检查认证状态和权限
3. API路由使用Token验证用户身份

### 2. 数据库访问层

**目录结构:**
- `src/lib/database.ts` - 数据库连接池和通用查询函数
- `src/lib/services/*.ts` - 领域特定的数据库操作

**职责:**
- 管理数据库连接池
- 提供数据库查询和事务功能
- 实现领域模型的CRUD操作

**关键交互:**
1. 服务层调用数据库层获取和修改数据
2. API路由通过服务层间接访问数据库

### 3. UI组件层

**目录结构:**
- `src/components/ui/` - 基础UI组件
- `src/components/layout/` - 布局组件
- `src/components/platform/` - 平台管理组件
- `src/components/member/` - 会员管理组件

**职责:**
- 实现用户界面元素
- 处理用户交互
- 表单状态管理和验证

**关键交互:**
1. 页面组件使用UI组件构建界面
2. UI组件通过React Context获取和更新应用状态
3. 表单组件通过API提交数据

### 4. 错误处理和日志系统

**目录结构:**
- `src/lib/error-handler.ts` - 错误处理工具
- `src/lib/logger.ts` - 日志记录
- `src/lib/api-utils.ts` - API响应处理

**职责:**
- 统一的错误分类和处理
- 结构化的日志记录
- 标准化的API响应格式

**关键交互:**
1. 所有模块使用日志系统记录重要信息
2. API路由使用错误处理工具处理和返回错误
3. 前端组件处理API响应中的错误信息

## 组件和服务的关系

在SNCRM项目中，组件和服务之间的关系遵循以下原则:

1. **数据流向**:
   - 数据从服务层流向UI组件
   - 用户操作通过UI组件传递给服务层

2. **职责分离**:
   - UI组件负责展示和用户交互
   - 服务层负责业务逻辑和数据处理
   - 工具库提供通用功能

3. **依赖关系**:
   ```
   UI组件 → Hooks/Context → 服务层 → 数据库访问层
   ```

4. **具体实例**:
   - Banner管理:
     - `src/components/platform/banner/` - Banner UI组件
     - `src/lib/services/banner-service.ts` - Banner服务
     - `src/app/api/platform/banner/` - Banner API路由

   - 认证系统:
     - `src/components/login-form.tsx` - 登录表单
     - `src/lib/auth.ts` - 认证工具
     - `src/app/api/auth/` - 认证API路由

## 设计模式和最佳实践

1. **单例模式**:
   - 数据库连接池采用单例模式，避免资源浪费
   - 日志记录器通过工厂方法创建模块特定的实例

2. **工厂模式**:
   - 日志系统使用工厂方法创建针对不同模块的日志记录器
   - 错误处理系统为不同类型的错误提供工厂函数

3. **策略模式**:
   - 认证系统根据运行环境选择不同的Token处理策略

4. **代码组织原则**:
   - 遵循关注点分离原则，将UI、业务逻辑和数据访问分开
   - 使用TypeScript类型系统确保类型安全
   - 采用统一的错误处理和日志记录策略

## 扩展和维护建议

1. **新功能添加流程**:
   - 定义类型(src/types/)
   - 实现服务层(src/lib/services/)
   - 创建API路由(src/app/api/)
   - 开发UI组件(src/components/)
   - 添加页面路由(src/app/)

2. **维护建议**:
   - 遵循现有的文件命名和组织结构
   - 保持类型定义、服务实现和API路由之间的一致性
   - 为新组件创建详细的文档

3. **代码规范**:
   - 使用TypeScript编写所有代码
   - 添加详细的注释和类型定义
   - 采用统一的错误处理和日志记录方式

## 附录: 关键文件和目录

```
src/
├── app/                    # App Router 路由
│   ├── (dashboard)/       # 仪表盘相关页面
│   ├── api/               # API 路由
│   └── layout.tsx         # 根布局
├── components/            # 共享组件
│   ├── layout/           # 布局组件
│   └── ui/               # UI组件
├── contexts/             # React Context
├── hooks/                # 自定义Hooks
├── lib/                  # 工具函数和服务
│   ├── services/        # 业务服务
│   ├── token.ts         # JWT处理(Node.js环境)
│   ├── token-edge.ts    # JWT处理(Edge环境)
│   ├── database.ts      # 数据库连接
│   ├── error-handler.ts # 错误处理
│   └── logger.ts        # 日志系统
└── types/                # TypeScript类型定义
``` 