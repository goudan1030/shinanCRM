# 服务器端漏洞修复指南

## 问题说明

在服务器上执行 `git pull` 时，如果本地有未提交的修改（特别是 `package.json`），会出现冲突错误。

## 快速修复步骤

### 方法一：使用服务器修复脚本（推荐）

1. **将修复脚本上传到服务器**，或直接在服务器上创建：

```bash
cd /www/wwwroot/admin.xinghun.info
# 如果脚本已存在，直接运行
./scripts/server-fix-cve-2025-66478.sh
```

2. **如果脚本不存在**，可以手动执行以下命令：

```bash
cd /www/wwwroot/admin.xinghun.info

# 1. 备份并暂存本地修改
cp package.json package.json.backup
git stash push -m "临时保存本地修改"

# 2. 拉取最新代码
git pull origin main

# 3. 升级 Next.js
npm install next@15.2.6 eslint-config-next@15.2.6 --save --save-exact

# 4. 重新构建
rm -rf .next
npm run build

# 5. 重启应用
pm2 restart sncrm
# 或
pm2 restart admin.xinghun.info
```

### 方法二：手动处理 Git 冲突

```bash
cd /www/wwwroot/admin.xinghun.info

# 1. 查看本地修改
git status
git diff package.json

# 2. 备份本地修改（如果需要保留）
cp package.json package.json.local

# 3. 暂存本地修改
git stash

# 4. 拉取最新代码
git pull origin main

# 5. 如果需要恢复本地修改（通常不需要，因为我们要升级）
# git stash pop

# 6. 升级 Next.js
npm install next@15.2.6 eslint-config-next@15.2.6 --save --save-exact

# 7. 重新构建
rm -rf .next
npm run build

# 8. 重启应用
pm2 restart sncrm
```

### 方法三：强制覆盖本地修改（谨慎使用）

如果确定不需要保留本地修改：

```bash
cd /www/wwwroot/admin.xinghun.info

# 1. 丢弃本地修改
git checkout -- package.json

# 2. 拉取最新代码
git pull origin main

# 3. 升级 Next.js
npm install next@15.2.6 eslint-config-next@15.2.6 --save --save-exact

# 4. 重新构建
rm -rf .next
npm run build

# 5. 重启应用
pm2 restart sncrm
```

## 验证修复

修复完成后，请验证：

```bash
# 1. 检查 Next.js 版本（应显示 15.2.6）
npm list next

# 2. 检查应用状态
pm2 status
pm2 logs sncrm --lines 50

# 3. 测试应用响应
curl http://localhost:3000
# 或访问实际域名测试
```

## 常见问题

### Q: git pull 提示有冲突怎么办？

A: 使用 `git stash` 暂存本地修改，然后 pull，最后升级 Next.js。

### Q: 修复脚本不存在怎么办？

A: 可以手动执行上述命令，或者从 GitHub 拉取最新代码后脚本会自动存在。

### Q: 如何确认修复成功？

A: 
1. 检查 `npm list next` 显示版本为 15.2.6
2. 应用正常运行
3. 没有错误日志

### Q: 如果升级后应用无法启动？

A:
1. 检查日志：`pm2 logs sncrm`
2. 检查构建是否成功：`npm run build`
3. 如有问题，可以回滚到备份版本

## 回滚方案

如果升级后出现问题，可以回滚：

```bash
# 1. 恢复 package.json 备份
cp package.json.backup package.json

# 2. 重新安装依赖
npm install

# 3. 重新构建
rm -rf .next
npm run build

# 4. 重启应用
pm2 restart sncrm
```

## 联系支持

如有问题，请检查：
- 应用日志：`pm2 logs sncrm`
- 构建日志：查看 `npm run build` 的输出
- 系统日志：`/www/wwwlogs/admin.xinghun.info.error.log`
