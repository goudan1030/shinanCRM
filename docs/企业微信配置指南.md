# 企业微信配置指南

## 📋 配置概述

本文档将指导您完成企业微信自建应用的配置，实现会员查询功能。

## 🔧 企业微信后台配置步骤

### 1. 登录企业微信管理后台

1. 访问 [企业微信管理后台](https://work.weixin.qq.com/wework_admin/)
2. 使用企业管理员账号登录

### 2. 创建自建应用

1. 进入 **应用管理** → **应用**
2. 点击 **创建应用**
3. 填写应用信息：
   - **应用名称**：会员查询系统
   - **应用介绍**：用于查询会员信息的自建应用
   - **应用logo**：上传合适的图标

### 3. 配置接收消息

1. 在应用详情页面，找到 **接收消息** 配置区域
2. 点击 **设置API接收**

#### 3.1 服务器配置

**URL配置：**
```
https://admin.xinghun.info/api/wecom/message
```

**Token配置：**
```
L411dhQg
```
> 💡 建议点击"随机获取"按钮生成新的Token，然后更新系统配置

**EncodingAESKey配置：**
```
点击"随机获取"按钮生成43位密钥
```

#### 3.2 消息类型配置

确保勾选以下消息类型：
- ✅ **用户发送的普通消息** - 必需
- ✅ **自定义菜单操作** - 可选
- ✅ **审批状态通知事件** - 可选

### 4. 配置应用权限

1. 在应用详情页面，找到 **权限管理**
2. 确保以下权限已开启：
   - **通讯录** - 读取企业通讯录
   - **应用** - 发送应用消息
   - **客户联系** - 读取客户信息（如果需要）

### 5. 获取应用信息

记录以下信息用于系统配置：
- **企业ID (corp_id)**
- **应用ID (agent_id)**
- **应用Secret (secret)**

## 🗄️ 数据库配置

### 1. 创建企业微信配置表

```sql
CREATE TABLE IF NOT EXISTS wecom_config (
  id INT PRIMARY KEY AUTO_INCREMENT,
  corp_id VARCHAR(100) NOT NULL COMMENT '企业ID',
  agent_id VARCHAR(100) NOT NULL COMMENT '应用ID',
  secret VARCHAR(200) NOT NULL COMMENT '应用Secret',
  token VARCHAR(100) DEFAULT 'L411dhQg' COMMENT 'Token',
  encoding_aes_key VARCHAR(200) COMMENT 'EncodingAESKey',
  member_notification_enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用会员通知',
  notification_recipients TEXT COMMENT '通知接收者，多个用逗号分隔',
  message_type ENUM('text', 'textcard', 'markdown') DEFAULT 'text' COMMENT '消息类型',
  custom_message_template TEXT COMMENT '自定义消息模板',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 2. 插入配置数据

```sql
INSERT INTO wecom_config (
  corp_id, 
  agent_id, 
  secret, 
  token, 
  encoding_aes_key,
  member_notification_enabled,
  notification_recipients,
  message_type
) VALUES (
  'your_corp_id',           -- 替换为您的企业ID
  'your_agent_id',          -- 替换为您的应用ID
  'your_secret',            -- 替换为您的应用Secret
  'L411dhQg',               -- Token
  'your_encoding_aes_key',  -- 替换为您的EncodingAESKey
  TRUE,
  '@all',                   -- 通知所有成员
  'text'
);
```

## 🔍 配置验证

### 1. 使用测试脚本验证

```bash
# 本地测试
npm run test:wecom

# 生产环境测试
npm run test:wecom:prod
```

### 2. 手动验证配置

访问以下URL验证配置：

```
GET https://admin.xinghun.info/api/wecom/config-check
GET https://admin.xinghun.info/api/wecom/status
GET https://admin.xinghun.info/api/wecom/test-query?number=M17071
```

### 3. 企业微信后台验证

1. 在企业微信后台点击 **保存** 按钮
2. 系统会自动验证URL配置
3. 如果验证失败，检查以下项目：
   - URL是否正确
   - Token是否匹配
   - 服务器是否正常运行

## 🚨 常见问题

### 1. URL验证失败

**可能原因：**
- URL格式错误
- Token不匹配
- 服务器未启动

**解决方案：**
1. 检查URL格式：`https://admin.xinghun.info/api/wecom/message`
2. 确保Token一致
3. 重启服务器

### 2. 消息接收失败

**可能原因：**
- 应用权限不足
- 消息类型未配置
- 服务器处理异常

**解决方案：**
1. 检查应用权限配置
2. 确保勾选"用户发送的普通消息"
3. 查看服务器日志

### 3. 无法发送消息

**可能原因：**
- Access Token过期
- 应用Secret错误
- 用户不在可见范围内

**解决方案：**
1. 检查应用Secret配置
2. 确保用户已添加到应用可见范围
3. 重新获取Access Token

## 📱 使用测试

### 1. 在企业微信中测试

1. 打开企业微信应用
2. 找到刚创建的应用
3. 发送会员编号进行测试：
   ```
   M17071
   10921
   A1234
   ```

### 2. 预期结果

- 发送编号后，系统会返回详细的会员信息
- 发送"帮助"会显示使用说明
- 发送无效编号会提示未找到

## 🔄 配置更新

如果需要更新配置：

1. **更新Token：**
   - 在企业微信后台重新生成Token
   - 更新数据库中的token字段

2. **更新EncodingAESKey：**
   - 在企业微信后台重新生成EncodingAESKey
   - 更新数据库中的encoding_aes_key字段

3. **更新应用信息：**
   - 如果重新创建了应用，更新corp_id、agent_id、secret

## 📞 技术支持

如果遇到配置问题，可以：

1. 查看服务器日志
2. 使用测试脚本诊断
3. 检查企业微信后台配置
4. 联系技术支持

---

**配置完成后，您的企业微信应用就可以正常接收和处理会员查询请求了！** 