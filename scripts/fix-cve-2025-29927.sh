#!/bin/bash

# CVE-2025-29927 Next.js 中间件权限绕过漏洞修复脚本
# 漏洞说明：攻击者可以通过操纵 x-middleware-subrequest 头来绕过授权检查
# 修复方案：
# 1. 升级 Next.js 到 15.2.3 或更高版本（主要修复）
# 2. 在 Nginx 配置中移除 x-middleware-subrequest 头（临时防护）

set -e

echo "=========================================="
echo "CVE-2025-29927 漏洞修复脚本"
echo "=========================================="
echo ""

# 颜色输出
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 检查是否在项目根目录
if [ ! -f "package.json" ]; then
    echo -e "${RED}错误：请在项目根目录运行此脚本${NC}"
    exit 1
fi

echo -e "${YELLOW}步骤 1: 升级 Next.js 和相关依赖${NC}"
echo "正在更新 package.json..."

# 检查当前 Next.js 版本
CURRENT_VERSION=$(grep -o '"next": "[^"]*"' package.json | cut -d'"' -f4)
echo "当前 Next.js 版本: $CURRENT_VERSION"

# 安装更新的依赖
echo "正在安装更新的依赖包..."
npm install next@^15.2.3 eslint-config-next@^15.2.3 --save --save-exact

echo -e "${GREEN}✓ Next.js 已升级到 15.2.3 或更高版本${NC}"
echo ""

echo -e "${YELLOW}步骤 2: 更新 Nginx 配置（临时防护）${NC}"

# 查找所有 Nginx 配置文件
NGINX_CONFIGS=(
    "/etc/nginx/sites-enabled/admin.xinghun.info"
    "/etc/nginx/conf.d/admin.xinghun.info.conf"
    "/www/server/panel/vhost/nginx/admin.xinghun.info.conf"
    "/www/server/nginx/conf/vhost/admin.xinghun.info.conf"
    "/etc/nginx/sites-enabled/crm.xinghun.info"
    "/etc/nginx/conf.d/crm.xinghun.info.conf"
    "/www/server/panel/vhost/nginx/crm.xinghun.info.conf"
    "/www/server/nginx/conf/vhost/crm.xinghun.info.conf"
)

NGINX_CONFIG_FOUND=false

for config_file in "${NGINX_CONFIGS[@]}"; do
    if [ -f "$config_file" ]; then
        echo "找到 Nginx 配置文件: $config_file"
        NGINX_CONFIG_FOUND=true
        
        # 检查是否已经添加了修复
        if grep -q "x-middleware-subrequest" "$config_file"; then
            echo -e "${GREEN}✓ 配置文件已包含漏洞修复${NC}"
        else
            # 备份原配置
            cp "$config_file" "${config_file}.backup.$(date +%Y%m%d_%H%M%S)"
            echo "已备份原配置到: ${config_file}.backup.$(date +%Y%m%d_%H%M%S)"
            
            # 在 location / 块中添加修复
            if grep -q "proxy_set_header X-Forwarded-Proto" "$config_file"; then
                # 在 X-Forwarded-Proto 行后添加修复
                sed -i '/proxy_set_header X-Forwarded-Proto/a\        # CVE-2025-29927 漏洞修复：移除可能被恶意利用的x-middleware-subrequest头\n        proxy_set_header x-middleware-subrequest "";' "$config_file"
                echo -e "${GREEN}✓ 已添加漏洞修复到配置文件${NC}"
            else
                echo -e "${YELLOW}⚠ 警告：无法自动添加修复，请手动在 location / 块中添加：${NC}"
                echo "        proxy_set_header x-middleware-subrequest \"\";"
            fi
        fi
        break
    fi
done

if [ "$NGINX_CONFIG_FOUND" = false ]; then
    echo -e "${YELLOW}⚠ 警告：未找到 Nginx 配置文件${NC}"
    echo "请手动在 Nginx 配置的 location / 块中添加以下内容："
    echo ""
    echo "        # CVE-2025-29927 漏洞修复：移除可能被恶意利用的x-middleware-subrequest头"
    echo "        proxy_set_header x-middleware-subrequest \"\";"
    echo ""
fi

echo ""
echo -e "${YELLOW}步骤 3: 重新构建应用${NC}"
echo "正在清理构建缓存..."
rm -rf .next

echo "正在构建应用..."
npm run build

echo -e "${GREEN}✓ 应用构建完成${NC}"
echo ""

echo -e "${YELLOW}步骤 4: 部署说明${NC}"
echo ""
echo "请按照以下步骤完成部署："
echo ""
echo "1. 如果修改了 Nginx 配置，请测试配置并重载："
echo "   sudo nginx -t"
echo "   sudo nginx -s reload"
echo ""
echo "2. 重启应用（根据您的部署方式选择）："
echo "   # 使用 PM2："
echo "   pm2 restart sncrm"
echo "   # 或"
echo "   pm2 restart admin.xinghun.info"
echo ""
echo "3. 验证修复："
echo "   - 检查 Next.js 版本：npm list next"
echo "   - 检查应用是否正常运行"
echo "   - 测试登录和权限控制功能"
echo ""
echo -e "${GREEN}=========================================="
echo "修复完成！"
echo "==========================================${NC}"
echo ""
echo "重要提醒："
echo "1. 升级到 Next.js 15.2.3+ 是主要修复方案"
echo "2. Nginx 配置修复是额外的防护措施"
echo "3. 建议在测试环境充分测试后再部署到生产环境"
echo "4. 建议创建服务器快照作为备份"
echo ""
