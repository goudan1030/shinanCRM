#!/bin/bash

# 服务器端 CVE-2025-66478 漏洞修复脚本
# 用于在服务器上直接修复漏洞，处理 git 冲突

set -e

echo "=========================================="
echo "CVE-2025-66478 漏洞修复脚本（服务器版）"
echo "Next.js React Server Components RCE 漏洞"
echo "=========================================="
echo ""

# 颜色输出
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 检查是否在项目根目录
if [ ! -f "package.json" ]; then
    echo -e "${RED}错误：请在项目根目录运行此脚本${NC}"
    exit 1
fi

echo -e "${RED}⚠️  警告：这是一个严重的远程代码执行漏洞！${NC}"
echo -e "${RED}必须立即升级 Next.js 到安全版本！${NC}"
echo ""

echo -e "${YELLOW}步骤 1: 处理本地 Git 修改${NC}"

# 检查是否有未提交的修改
if [ -n "$(git status --porcelain package.json)" ]; then
    echo "发现本地 package.json 有修改，正在备份..."
    cp package.json package.json.backup.$(date +%Y%m%d_%H%M%S)
    echo "已备份到: package.json.backup.$(date +%Y%m%d_%H%M%S)"
    
    # 询问是否要保留本地修改（这里自动选择丢弃，因为我们要升级）
    echo "正在暂存本地修改..."
    git stash push -m "临时保存本地修改 $(date +%Y%m%d_%H%M%S)"
    echo -e "${GREEN}✓ 本地修改已暂存${NC}"
fi

echo ""
echo -e "${YELLOW}步骤 2: 拉取最新代码${NC}"

# 拉取最新代码
git pull origin main

echo -e "${GREEN}✓ 代码已更新${NC}"
echo ""

echo -e "${YELLOW}步骤 3: 检查当前 Next.js 版本${NC}"

# 检查当前 Next.js 版本
CURRENT_VERSION=$(grep -o '"next": "[^"]*"' package.json | cut -d'"' -f4 | sed 's/[^0-9.]//g')
echo "当前 Next.js 版本: $CURRENT_VERSION"

# 确定需要升级到的版本
if [[ "$CURRENT_VERSION" == 15.0.* ]]; then
    TARGET_VERSION="15.0.5"
elif [[ "$CURRENT_VERSION" == 15.1.* ]]; then
    TARGET_VERSION="15.1.9"
elif [[ "$CURRENT_VERSION" == 15.2.* ]]; then
    TARGET_VERSION="15.2.6"
elif [[ "$CURRENT_VERSION" == 15.3.* ]]; then
    TARGET_VERSION="15.3.6"
elif [[ "$CURRENT_VERSION" == 15.4.* ]]; then
    TARGET_VERSION="15.4.8"
elif [[ "$CURRENT_VERSION" == 15.5.* ]]; then
    TARGET_VERSION="15.5.7"
elif [[ "$CURRENT_VERSION" == 16.0.* ]]; then
    TARGET_VERSION="16.0.7"
else
    # 默认升级到最新稳定版本
    TARGET_VERSION="15.2.6"
    echo -e "${YELLOW}⚠️  无法自动确定目标版本，将升级到 15.2.6${NC}"
fi

echo "目标 Next.js 版本: $TARGET_VERSION"
echo ""

echo -e "${YELLOW}步骤 4: 升级 Next.js 和相关依赖${NC}"
echo "正在安装更新的依赖包..."

# 安装更新的依赖
npm install next@$TARGET_VERSION eslint-config-next@$TARGET_VERSION --save --save-exact

echo -e "${GREEN}✓ Next.js 已升级到 $TARGET_VERSION${NC}"
echo ""

echo -e "${YELLOW}步骤 5: 重新构建应用${NC}"
echo "正在清理构建缓存..."
rm -rf .next

echo "正在构建应用..."
npm run build

echo -e "${GREEN}✓ 应用构建完成${NC}"
echo ""

echo -e "${YELLOW}步骤 6: 验证修复${NC}"

# 验证版本
INSTALLED_VERSION=$(npm list next 2>/dev/null | grep next@ | head -1 | awk '{print $2}' | sed 's/@//' || echo "")
if [ -z "$INSTALLED_VERSION" ]; then
    INSTALLED_VERSION=$(npm list next 2>/dev/null | grep "next@" | head -1 | sed 's/.*next@//' | awk '{print $1}' || echo "")
fi

echo "已安装的 Next.js 版本: $INSTALLED_VERSION"

if [[ "$INSTALLED_VERSION" == "$TARGET_VERSION"* ]] || [[ "$INSTALLED_VERSION" == *"$TARGET_VERSION"* ]]; then
    echo -e "${GREEN}✓ 版本验证通过${NC}"
else
    echo -e "${YELLOW}⚠️  版本验证：请手动确认版本是否正确${NC}"
fi

echo ""
echo -e "${YELLOW}步骤 7: 重启应用${NC}"

# 检查 PM2 进程
if command -v pm2 &> /dev/null; then
    echo "检测到 PM2，正在查找应用进程..."
    
    # 尝试查找可能的进程名
    PM2_PROCESSES=("sncrm" "admin.xinghun.info" "nextjs" "next")
    
    for proc in "${PM2_PROCESSES[@]}"; do
        if pm2 list | grep -q "$proc"; then
            echo "找到进程: $proc"
            echo "正在重启..."
            pm2 restart "$proc"
            echo -e "${GREEN}✓ 应用已重启${NC}"
            break
        fi
    done
    
    # 如果没有找到，列出所有进程让用户选择
    if ! pm2 list | grep -q "online\|stopped"; then
        echo -e "${YELLOW}未找到 PM2 进程，请手动重启应用${NC}"
        echo "可用的 PM2 命令："
        echo "  pm2 list          # 查看所有进程"
        echo "  pm2 restart <name> # 重启指定进程"
    fi
else
    echo -e "${YELLOW}未检测到 PM2，请手动重启应用${NC}"
    echo "如果使用其他进程管理器，请手动重启"
fi

echo ""
echo -e "${GREEN}=========================================="
echo "修复完成！"
echo "==========================================${NC}"
echo ""
echo -e "${RED}重要提醒：${NC}"
echo "1. 这是一个严重的远程代码执行漏洞，必须立即修复"
echo "2. 升级到安全版本是唯一有效的修复方案"
echo "3. 请验证应用是否正常运行"
echo "4. 检查应用日志确认无错误"
echo ""
echo "验证命令："
echo "  npm list next                    # 检查 Next.js 版本"
echo "  pm2 logs sncrm                   # 查看应用日志"
echo "  curl http://localhost:3000       # 测试应用响应"
echo ""
